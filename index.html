<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Seleksi (Subfolders)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <nav class="bg-white shadow sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="overflow-hidden">
                <h1 class="font-bold text-gray-900 truncate" id="title">Memuat...</h1>
                <p class="text-[10px] text-gray-500" id="statusText">Menghubungkan...</p>
            </div>
            <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold border border-blue-100 whitespace-nowrap ml-2">
                Sisa: <span id="quotaLeft">0</span>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="max-w-6xl mx-auto px-2 py-4 min-h-screen">
        <!-- Loader -->
        <div id="loader" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
            <p class="mt-4 text-xs font-mono text-gray-500" id="loadingMsg">Sedang memindai folder...</p>
        </div>

        <!-- Error -->
        <div id="error" class="hidden text-center py-20 px-6">
            <div class="text-red-400 text-4xl mb-2"><i class="fas fa-exclamation-triangle"></i></div>
            <p id="errMsg" class="text-sm text-gray-600">Error.</p>
        </div>

        <!-- Gallery -->
        <div id="grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1 md:gap-3 hidden"></div>
    </main>

    <!-- Footer -->
    <div id="footer" class="fixed bottom-0 left-0 w-full bg-white border-t z-50 transform translate-y-full transition-transform duration-300 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="max-w-6xl mx-auto p-2 flex flex-col md:flex-row gap-2">
            <div class="flex-1 overflow-hidden">
                <div class="flex justify-between px-1 mb-1 text-[10px] text-gray-500 uppercase font-bold">
                    <span>Terpilih: <span id="count" class="text-blue-600">0</span> / <span id="max">0</span></span>
                    <span id="warn" class="text-red-500 hidden">Penuh!</span>
                </div>
                <div id="thumbs" class="flex gap-2 overflow-x-auto h-14 items-center scrollbar-hide px-1"></div>
            </div>
            <div class="flex gap-2 border-t md:border-t-0 pt-2 md:pt-0">
                <button onclick="reset()" class="bg-gray-100 text-gray-600 px-3 rounded-lg"><i class="fas fa-trash"></i></button>
                <button onclick="processOrder()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-bold shadow-md active:scale-95 transition flex items-center justify-center gap-2 whitespace-nowrap">
                    <i class="fas fa-paper-plane"></i> Kirim
                </button>
            </div>
        </div>
    </div>

    <!-- Sending Overlay -->
    <div id="sendingOverlay" class="fixed inset-0 bg-black bg-opacity-80 z-[60] hidden flex flex-col items-center justify-center text-white px-6 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
        <h3 class="font-bold text-lg">Menyimpan...</h3>
        <p class="text-sm text-gray-300 mt-2">Mohon tunggu, jangan tutup halaman ini.</p>
    </div>

    <script>
        // --- API KEY (READ ONLY) ---
        const API_KEY = "AIzaSyCLT22kOThpBwxkzNQt3mEFQpoKcLr9zMk"; 

        let state = { id: '', name: '', limit: 0, script: '', wa: '', photos: [], selected: new Set() };

        window.onload = async () => {
            const p = new URLSearchParams(window.location.search);
            state.name = p.get('p');
            state.limit = parseInt(p.get('q'));
            state.id = p.get('f');
            state.script = p.get('s');
            state.wa = p.get('w');

            if(!state.name || !state.id) return fail("Link rusak.");

            document.getElementById('title').innerText = state.name;
            updateUI();
            
            // Mulai Scan Folder secara Rekursif
            await startDeepScan(state.id);
        };

        // --- DEEP SCAN LOGIC (SUBFOLDERS) ---
        async function startDeepScan(rootId) {
            try {
                let allPhotos = [];
                let foldersToScan = [rootId]; // Queue folder yang harus discan
                
                // Batasi kedalaman loop agar tidak infinite (Max scan 20 folder sub-level)
                let safetyCounter = 0; 
                
                while(foldersToScan.length > 0 && safetyCounter < 50) {
                    safetyCounter++;
                    
                    // Ambil folder pertama di antrian
                    let currentFolderId = foldersToScan.shift();
                    document.getElementById('loadingMsg').innerText = `Memindai folder... (${allPhotos.length} foto ditemukan)`;

                    // Fetch isi folder ini
                    let result = await fetchFolderContents(currentFolderId);
                    
                    // Masukkan foto yang ditemukan ke array utama
                    allPhotos = allPhotos.concat(result.photos);
                    
                    // Masukkan sub-folder yang ditemukan ke antrian untuk discan selanjutnya
                    foldersToScan = foldersToScan.concat(result.subFolders);
                }

                if(allPhotos.length === 0) throw new Error("Tidak ditemukan foto (JPG/PNG) di folder ini maupun sub-foldernya.");

                state.photos = allPhotos;
                document.getElementById('statusText').innerText = `${allPhotos.length} Foto dimuat`;
                renderGrid();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('grid').classList.remove('hidden');

            } catch (e) { fail(e.message); }
        }

        async function fetchFolderContents(folderId) {
            // Query: cari File (Image) ATAU Folder di dalam folderId
            const q = `'${folderId}' in parents and (mimeType contains 'image/' or mimeType = 'application/vnd.google-apps.folder') and trashed = false`;
            const fields = "files(id, name, mimeType, thumbnailLink, webContentLink)";
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${fields}&key=${API_KEY}&pageSize=100`;

            const res = await fetch(url);
            const data = await res.json();
            
            if(data.error) throw new Error(data.error.message);

            let photos = [];
            let subFolders = [];

            if(data.files) {
                data.files.forEach(f => {
                    if(f.mimeType.includes('folder')) {
                        subFolders.push(f.id);
                    } else {
                        photos.push({
                            id: f.id, 
                            name: f.name,
                            url: f.thumbnailLink ? f.thumbnailLink.replace(/=s\d+/, '=s400') : f.webContentLink
                        });
                    }
                });
            }
            return { photos, subFolders };
        }

        // --- UI FUNCTIONS ---
        function renderGrid() {
            const g = document.getElementById('grid');
            g.innerHTML = '';
            state.photos.forEach(p => {
                const isSel = state.selected.has(p.id);
                const d = document.createElement('div');
                d.className = `relative aspect-square bg-gray-200 overflow-hidden cursor-pointer ${isSel ? 'ring-4 ring-green-500' : ''}`;
                d.onclick = () => toggle(p.id);
                d.innerHTML = `
                    <img src="${p.url}" class="w-full h-full object-cover ${isSel ? 'opacity-40' : ''}" loading="lazy">
                    ${isSel ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-check text-2xl text-green-600 bg-white rounded-full p-1"></i></div>' : ''}
                    <div class="absolute bottom-0 w-full bg-black/50 text-white text-[9px] p-1 truncate text-center">${p.name}</div>
                `;
                g.appendChild(d);
            });
        }

        function toggle(id) {
            if(state.selected.has(id)) state.selected.delete(id);
            else {
                if(state.selected.size >= state.limit) { alert("Kuota Penuh!"); return; }
                state.selected.add(id);
            }
            renderGrid(); renderFooter(); updateUI();
        }

        function renderFooter() {
            const f = document.getElementById('footer');
            const t = document.getElementById('thumbs');
            t.innerHTML = '';
            state.selected.size > 0 ? f.classList.remove('translate-y-full') : f.classList.add('translate-y-full');

            state.selected.forEach(id => {
                const p = state.photos.find(x => x.id === id);
                if(p) {
                    const img = document.createElement('img');
                    img.src = p.url;
                    img.className = "h-12 w-12 rounded border border-gray-300 cursor-pointer";
                    img.onclick = () => toggle(id);
                    t.appendChild(img);
                }
            });
        }

        function updateUI() {
            const c = state.selected.size;
            document.getElementById('count').innerText = c;
            document.getElementById('max').innerText = state.limit;
            document.getElementById('quotaLeft').innerText = state.limit - c;
            document.getElementById('warn').style.display = c >= state.limit ? 'inline' : 'none';
        }

        // --- SENDING PROCESS ---
        async function processOrder() {
            if(state.selected.size === 0) return;
            if(!confirm(`Kirim ${state.selected.size} foto sekarang?`)) return;

            document.getElementById('sendingOverlay').classList.remove('hidden');

            const fileList = [];
            state.selected.forEach(id => {
                const p = state.photos.find(x => x.id === id);
                if(p) fileList.push(p.name);
            });

            try {
                if(state.script) {
                    await fetch(state.script, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            projectName: state.name,
                            files: fileList
                        })
                    });
                }
                
                await new Promise(r => setTimeout(r, 1500));
                document.getElementById('sendingOverlay').classList.add('hidden');

                const waText = `*${state.name}*\nTotal: ${fileList.length} Foto\n\nFilename:\n` + fileList.join('\n');
                const phone = state.wa || ""; 
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(waText)}`, '_blank');
                
                state.selected.clear(); renderGrid(); renderFooter(); updateUI();

            } catch (e) {
                document.getElementById('sendingOverlay').classList.add('hidden');
                alert("Gagal koneksi server, mengalihkan ke WhatsApp...");
                const waText = `*${state.name}*\nTotal: ${fileList.length} Foto\n\nFilename:\n` + fileList.join('\n');
                window.open(`https://wa.me/${state.wa}?text=${encodeURIComponent(waText)}`, '_blank');
            }
        }

        function reset() { if(confirm('Reset?')) { state.selected.clear(); renderGrid(); renderFooter(); updateUI(); } }
        function fail(msg) { document.getElementById('error').classList.remove('hidden'); document.getElementById('errMsg').innerText = msg; document.getElementById('loader').classList.add('hidden'); }
    </script>
</body>
</html>

