<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galeri Seleksi Foto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#121212',
                        darkcard: '#1e1e1e',
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-touch-callout: none; }
        
        /* Tab Styles */
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .dark .tab-active { border-bottom: 2px solid #60a5fa; color: #60a5fa; }
        .tab-inactive { color: #6b7280; }
        .dark .tab-inactive { color: #9ca3af; }

        /* Watermark */
        .watermark-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 3rem; font-weight: 900; color: rgba(255, 255, 255, 0.2);
            pointer-events: none; white-space: nowrap; z-index: 20; text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Smooth Slide Transition for Maximize Panel */
        .slide-panel { transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .slide-panel.dragging { transition: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-darkbg dark:text-gray-100 transition-colors duration-300 pb-44 overflow-x-hidden">

    <!-- HEADER -->
    <div class="bg-white dark:bg-darkcard shadow sticky top-0 z-40 transition-colors duration-300 select-none">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center border-b border-gray-100 dark:border-gray-700">
            <div class="overflow-hidden flex-1 mr-2">
                <h1 class="font-bold text-gray-900 dark:text-white truncate text-sm md:text-base" id="title">Memuat...</h1>
                <p class="text-[10px] text-gray-500 dark:text-gray-400">Tekan tahan foto untuk Zoom</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded-full text-xs font-bold border border-blue-100 dark:border-blue-800 whitespace-nowrap">
                    Sisa: <span id="quotaLeft">0</span>
                </div>
                <button onclick="toggleSort()" class="text-gray-500 dark:text-gray-300 hover:text-blue-600 p-1"><i id="sortIcon" class="fas fa-sort-alpha-down text-lg"></i></button>
                <button onclick="toggleTheme()" class="text-gray-500 dark:text-yellow-400 hover:text-blue-600 p-1"><i id="themeIcon" class="fas fa-moon text-lg"></i></button>
            </div>
        </div>

        <div class="max-w-6xl mx-auto relative group">
            <!-- Tab Scroll Buttons (Hidden on Mobile) -->
            <button onclick="scrollEl('tabsContainer', -1)" class="hidden md:block absolute left-0 top-0 bottom-0 bg-white/80 dark:bg-darkcard/80 px-2 z-10 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-chevron-left text-xs"></i></button>
            
            <div id="tabsContainer" class="flex overflow-x-auto scrollbar-hide px-4 md:px-8 scroll-smooth">
                <div class="px-4 py-3 text-sm text-gray-400 dark:text-gray-500 whitespace-nowrap">Loading folders...</div>
            </div>
            
            <button onclick="scrollEl('tabsContainer', 1)" class="hidden md:block absolute right-0 top-0 bottom-0 bg-white/80 dark:bg-darkcard/80 px-2 z-10 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-chevron-right text-xs"></i></button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <main class="max-w-6xl mx-auto px-2 py-4 min-h-screen">
        <div id="loader" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
            <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Syncing Drive...</p>
        </div>
        <div id="error" class="hidden text-center py-20 px-6">
            <div class="text-red-400 text-4xl mb-2"><i class="fas fa-unlink"></i></div>
            <p id="errMsg" class="text-sm text-gray-600 dark:text-gray-400">Error.</p>
        </div>
        <div id="grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1 md:gap-3 hidden"></div>
    </main>

    <!-- FOOTER PANEL (Swipeable) -->
    <!-- Tinggi visible 180px -->
    <div id="footer" class="fixed bottom-0 left-0 w-full h-[90vh] bg-white dark:bg-darkcard border-t dark:border-gray-700 z-50 transform translate-y-[calc(100%-180px)] slide-panel shadow-[0_-5px_20px_rgba(0,0,0,0.3)] flex flex-col rounded-t-2xl select-none">
        
        <!-- Handle Bar (Area Geser) -->
        <div id="footerHandle" class="w-full flex justify-center py-3 cursor-grab hover:bg-gray-50 dark:hover:bg-gray-700 border-b dark:border-gray-700 flex-shrink-0 touch-none bg-gray-50 dark:bg-darkcard rounded-t-2xl">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
            <i id="chevronIcon" class="fas fa-chevron-up absolute right-4 top-3 text-gray-400 text-sm"></i>
        </div>

        <!-- Footer Content (Collapsed View) -->
        <!-- Menggunakan flex-row agar info thumbnail dan tombol berdampingan -->
        <div class="max-w-6xl mx-auto p-3 flex flex-row gap-4 w-full bg-white dark:bg-darkcard h-[180px]">
            
            <!-- Left Side: Info & Thumbs (Expandable) -->
            <div class="flex-1 flex flex-col gap-1 overflow-hidden">
                <div class="flex justify-between px-1 text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold">
                    <span>Terpilih: <span id="count" class="text-blue-600 dark:text-blue-400">0</span> / <span id="max">0</span></span>
                    <span id="warn" class="text-red-500 hidden">Penuh!</span>
                </div>
                
                <!-- Thumbnail Strip dengan Panah (Hidden on Mobile) -->
                <div class="relative group flex-1 flex flex-col justify-center">
                    <button onclick="scrollEl('thumbs', -1)" class="hidden md:block absolute left-0 top-0 bottom-0 bg-white/90 dark:bg-darkcard/90 px-2 z-10 hover:bg-gray-100 dark:hover:bg-gray-700 shadow-sm h-full"><i class="fas fa-chevron-left text-xs"></i></button>
                    
                    <div id="thumbs" class="flex gap-2 overflow-x-auto h-full items-center scrollbar-hide px-1 md:px-8 transition-all scroll-smooth"></div>
                    
                    <button onclick="scrollEl('thumbs', 1)" class="hidden md:block absolute right-0 top-0 bottom-0 bg-white/90 dark:bg-darkcard/90 px-2 z-10 hover:bg-gray-100 dark:hover:bg-gray-700 shadow-sm h-full"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            </div>
            
            <!-- Right Side: Main Action Buttons (Horizontal & Bottom Aligned) -->
            <!-- flex-col justify-end memastikan tombol menempel di bawah -->
            <div class="flex flex-col justify-end flex-shrink-0 pb-2">
                <div class="flex items-center gap-2">
                    <button onclick="reset()" class="h-10 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-3 rounded-lg flex items-center justify-center gap-1 text-xs font-bold border border-gray-200 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Hapus Semua">
                        <i class="fas fa-trash"></i>
                    </button>
                    
                    <button onclick="processOrder()" class="h-10 bg-green-600 hover:bg-green-700 text-white px-5 rounded-lg text-sm font-bold shadow-md active:scale-95 transition flex items-center justify-center gap-2 whitespace-nowrap">
                        <i class="fas fa-paper-plane"></i> KIRIM
                    </button>
                </div>
            </div>
        </div>

        <!-- MAXIMIZED CONTENT (Expanded View) -->
        <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-black p-4 w-full border-t dark:border-gray-800">
            <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-4 px-2">Review Pilihan Foto</h3>
            <p class="text-xs text-gray-500 px-2 mb-2">Klik foto untuk memperbesar. Klik X merah untuk menghapus.</p>
            <!-- Grid Maximize (Fixed Layout) -->
            <div id="maximizedGrid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-2 content-start pb-44">
                <!-- Foto akan diinject disini -->
            </div>
        </div>
    </div>

    <!-- PREVIEW MODAL (Super Lightbox) -->
    <div id="previewModal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col justify-between select-none">
        <!-- Top Bar -->
        <div class="flex justify-between items-center p-4 z-20">
            <div class="text-white text-sm font-mono truncate max-w-[200px]" id="previewName">filename.jpg</div>
            <button onclick="closePreview()" class="text-white text-3xl p-2"><i class="fas fa-times"></i></button>
        </div>

        <!-- Main Image Area -->
        <div class="relative flex-1 flex items-center justify-center overflow-hidden" id="previewContainer">
            <img id="previewImg" src="" class="max-w-full max-h-full object-contain transition-transform duration-200">
            <div class="watermark-text" id="watermarkText">PREVIEW</div>
            
            <!-- Navigation Arrows -->
            <button onclick="prevPreview()" class="absolute left-2 top-1/2 -translate-y-1/2 text-white/70 hover:text-white p-4 text-3xl z-30 bg-black/20 rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
            <button onclick="nextPreview()" class="absolute right-2 top-1/2 -translate-y-1/2 text-white/70 hover:text-white p-4 text-3xl z-30 bg-black/20 rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Bottom Action Bar -->
        <div class="bg-gradient-to-t from-black via-black/80 to-transparent p-6 pb-8 z-20 flex justify-center">
            <button id="previewSelectBtn" onclick="toggleFromPreview()" class="w-full max-w-md bg-gray-800 border border-gray-500 text-white py-4 rounded-full font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-3">
                <i class="far fa-circle"></i> PILIH FOTO INI
            </button>
        </div>
    </div>

    <!-- Sending Overlay -->
    <div id="sendingOverlay" class="fixed inset-0 bg-black bg-opacity-80 z-[70] hidden flex flex-col items-center justify-center text-white px-6 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
        <h3 class="font-bold text-lg">Menyimpan Data...</h3>
        <p class="text-sm text-gray-300 mt-2">Mohon tunggu sebentar.</p>
    </div>

    <script>
        // --- CONFIG ---
        const API_KEY = "AIzaSyCLT22kOThpBwxkzNQt3mEFQpoKcLr9zMk"; // Ganti API Key
        const CONST_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPkgt5qVEPLEBeba7nPoxFL8TPkRpoCIG5Z_tCwAH78hQXJrJrXYydNass915lqNOn/exec";

        // State Global
        let state = { 
            id: '', name: '', limit: 0, wa: '', 
            tabs: [], activeTabId: null, selected: new Set(), allPhotosMap: new Map(), sortAsc: true,
            currentPreviewIndex: 0,
            currentPreviewList: [], 
            isFooterExpanded: false
        };

        // --- INIT ---
        window.onload = async () => {
            if(localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun'); }
            
            const p = new URLSearchParams(window.location.search);
            state.name = p.get('p'); state.limit = parseInt(p.get('q')); state.id = p.get('f'); state.wa = p.get('w');
            if(!state.name || !state.id) return fail("Link rusak.");
            
            document.getElementById('title').innerText = state.name;
            document.getElementById('watermarkText').innerText = state.name.toUpperCase();
            
            loadDraft(); updateUI();
            initFooterSwipe(); 
            initPreviewSwipe(); 
            
            await initContent(state.id);
        };

        // --- CORE FETCH ---
        async function initContent(rootId) {
            try {
                const data = await fetchDriveFolder(rootId);
                let tabs = [], rootPhotos = [], subFolders = [];
                data.files.forEach(f => {
                    if(f.mimeType.includes('folder')) subFolders.push(f);
                    else if(f.mimeType.includes('image')) rootPhotos.push(mapPhoto(f));
                });
                if(rootPhotos.length > 0) {
                    tabs.push({ id: 'root', name: 'Utama', photos: rootPhotos });
                    rootPhotos.forEach(p => state.allPhotosMap.set(p.id, p));
                }
                subFolders.forEach(f => tabs.push({ id: f.id, name: f.name, photos: null }));
                if(tabs.length === 0) throw new Error("Folder kosong.");
                state.tabs = tabs; renderTabs(); switchTab(tabs[0].id);
                document.getElementById('loader').classList.add('hidden');
            } catch (e) { fail(e.message); }
        }

        async function fetchDriveFolder(fid) {
            const q = `'${fid}' in parents and (mimeType contains 'image/' or mimeType = 'application/vnd.google-apps.folder') and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)&key=${API_KEY}&pageSize=1000`;
            const res = await fetch(url); return await res.json();
        }

        function mapPhoto(f) {
            return {
                id: f.id, name: f.name,
                url: f.thumbnailLink ? f.thumbnailLink.replace(/=s\d+/, '=s500') : f.webContentLink,
                previewUrl: f.thumbnailLink ? f.thumbnailLink.replace(/=s\d+/, '=s1600') : f.webContentLink
            };
        }

        // --- TABS & GRID ---
        function renderTabs() {
            const c = document.getElementById('tabsContainer'); c.innerHTML = '';
            state.tabs.forEach(t => {
                const b = document.createElement('button'); b.id = `tab-${t.id}`;
                b.className = `px-4 py-3 text-sm whitespace-nowrap border-b-2 border-transparent transition-colors tab-inactive`;
                b.innerText = t.name; b.onclick = () => switchTab(t.id); c.appendChild(b);
            });
        }

        async function switchTab(id) {
            state.activeTabId = id;
            state.tabs.forEach(t => {
                const el = document.getElementById(`tab-${t.id}`);
                if(t.id===id) { el.classList.remove('tab-inactive'); el.classList.add('tab-active'); el.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }
                else { el.classList.add('tab-inactive'); el.classList.remove('tab-active'); }
            });

            const t = state.tabs.find(x => x.id === id);
            if(t.photos === null) {
                document.getElementById('grid').innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Memuat...</div>';
                document.getElementById('grid').classList.remove('hidden');
                try {
                    const res = await fetchDriveFolder(id);
                    const photos = res.files.filter(f=>f.mimeType.includes('image')).map(mapPhoto);
                    t.photos = photos; photos.forEach(p => state.allPhotosMap.set(p.id, p));
                } catch(e) { return; }
            }
            renderGrid(t.photos);
        }

        function renderGrid(photos) {
            const g = document.getElementById('grid'); g.innerHTML = '';
            if(!photos || photos.length===0) { g.innerHTML='<div class="col-span-full text-center py-10 text-gray-400 text-sm">Folder kosong.</div>'; return; }
            
            const sorted = [...photos].sort((a,b) => state.sortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
            
            sorted.forEach((p, index) => {
                const sel = state.selected.has(p.id);
                const el = document.createElement('div');
                el.className = `relative aspect-square bg-gray-200 dark:bg-gray-700 overflow-hidden cursor-pointer select-none rounded-lg ${sel?'ring-4 ring-green-500':''}`;
                
                // Gunakan mode 'grid' untuk preview dari daftar utama
                setupInteraction(el, p, index, 'grid', sorted);

                el.innerHTML = `<img src="${p.url}" class="w-full h-full object-cover pointer-events-none transition duration-300 ${sel?'opacity-40':''}" loading="lazy">${sel?'<div class="absolute inset-0 flex items-center justify-center pointer-events-none"><i class="fas fa-check text-3xl text-green-600 bg-white rounded-full p-1 shadow"></i></div>':''}<div class="absolute bottom-0 w-full bg-black/50 text-white text-[9px] p-1 truncate text-center">${p.name}</div>`;
                g.appendChild(el);
            });
            g.classList.remove('hidden');
        }

        function setupInteraction(el, photo, index, contextMode, photoList) {
            let timer;
            const start = () => { 
                timer = setTimeout(() => {
                    // Set daftar preview sesuai konteks (Grid Utama atau Daftar Terpilih)
                    state.currentPreviewList = photoList;
                    openPreview(index);
                }, 400); 
            }; 
            const stop = () => clearTimeout(timer);
            
            el.addEventListener('touchstart', start, {passive:true});
            el.addEventListener('touchend', stop);
            el.addEventListener('touchmove', stop);
            el.addEventListener('mousedown', (e)=>{if(e.button===0)start()});
            el.addEventListener('mouseup', stop);
            
            el.onclick = () => toggle(photo.id);
            el.oncontextmenu = (e) => { e.preventDefault(); return false; };
        }

        // --- PREVIEW SYSTEM ---
        function openPreview(index) {
            state.currentPreviewIndex = index;
            const modal = document.getElementById('previewModal');
            modal.classList.remove('hidden');
            updatePreviewUI();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function updatePreviewUI() {
            const photo = state.currentPreviewList[state.currentPreviewIndex];
            if(!photo) return;

            document.getElementById('previewImg').src = photo.previewUrl;
            document.getElementById('previewName').innerText = `${state.currentPreviewIndex + 1}/${state.currentPreviewList.length} - ${photo.name}`;
            
            const btn = document.getElementById('previewSelectBtn');
            if(state.selected.has(photo.id)) {
                btn.className = "w-full max-w-md bg-green-600 border border-green-400 text-white py-4 rounded-full font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-3";
                btn.innerHTML = `<i class="fas fa-check-circle"></i> SUDAH DIPILIH`;
            } else {
                btn.className = "w-full max-w-md bg-gray-800 border border-gray-500 text-white py-4 rounded-full font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-3";
                btn.innerHTML = `<i class="far fa-circle"></i> PILIH FOTO INI`;
            }
        }

        function nextPreview() {
            if(state.currentPreviewIndex < state.currentPreviewList.length - 1) {
                state.currentPreviewIndex++;
                updatePreviewUI();
            }
        }
        function prevPreview() {
            if(state.currentPreviewIndex > 0) {
                state.currentPreviewIndex--;
                updatePreviewUI();
            }
        }
        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }
        
        function toggleFromPreview() {
            const photo = state.currentPreviewList[state.currentPreviewIndex];
            toggle(photo.id);
            updatePreviewUI(); 
        }

        function initPreviewSwipe() {
            const el = document.getElementById('previewContainer');
            let startX = 0;
            el.addEventListener('touchstart', e => startX = e.touches[0].clientY < 50 ? 0 : e.touches[0].clientX, {passive:true});
            el.addEventListener('touchend', e => {
                const diff = startX - e.changedTouches[0].clientX;
                if(Math.abs(diff) > 50) diff > 0 ? nextPreview() : prevPreview();
            });
        }

        // --- SELECTION Logic ---
        function toggle(id) {
            if(state.selected.has(id)) state.selected.delete(id);
            else { if(state.selected.size >= state.limit){ alert("Kuota Penuh!"); return; } state.selected.add(id); }
            
            saveDraft();
            
            if (state.activeTabId) {
                const currentTab = state.tabs.find(t => t.id === state.activeTabId);
                if (currentTab && currentTab.photos) {
                    renderGrid(currentTab.photos);
                }
            }
            renderFooter();
            updateUI();
            
            if(state.isFooterExpanded) renderMaximizedGrid();
        }

        // --- FOOTER LOGIC ---
        function initFooterSwipe() {
            const handle = document.getElementById('footerHandle');
            const footer = document.getElementById('footer');
            let startY = 0; let currentY = 0;

            handle.onclick = () => { state.isFooterExpanded ? collapseFooter() : expandFooter(); };

            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                footer.classList.add('dragging');
            }, {passive: false});

            handle.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                currentY = e.touches[0].clientY;
                const delta = currentY - startY;

                // Hitung offset berdasarkan state saat ini
                // 180px adalah tinggi visible panel bawah (collapsed)
                if(!state.isFooterExpanded && delta < 0) {
                    footer.style.transform = `translateY(calc(100% - 180px + ${delta}px))`;
                } else if (state.isFooterExpanded && delta > 0) {
                    footer.style.transform = `translateY(${delta}px)`;
                }
            }, {passive: false});

            handle.addEventListener('touchend', (e) => {
                footer.classList.remove('dragging');
                footer.style.transform = '';
                const delta = currentY - startY;
                if(!state.isFooterExpanded && delta < -50) expandFooter();
                else if(state.isFooterExpanded && delta > 50) collapseFooter();
                else state.isFooterExpanded ? expandFooter() : collapseFooter();
            });
        }

        function expandFooter() {
            const footer = document.getElementById('footer');
            const chevron = document.getElementById('chevronIcon');
            // Menampilkan penuh
            footer.classList.remove('translate-y-[calc(100%-180px)]');
            footer.classList.add('translate-y-0');
            chevron.className = "fas fa-chevron-down absolute right-4 top-3 text-gray-400 text-sm";
            state.isFooterExpanded = true;
            renderMaximizedGrid();
        }

        function collapseFooter() {
            const footer = document.getElementById('footer');
            const chevron = document.getElementById('chevronIcon');
            // Menyembunyikan sebagian besar (sisa 180px)
            footer.classList.remove('translate-y-0');
            footer.classList.add('translate-y-[calc(100%-180px)]');
            chevron.className = "fas fa-chevron-up absolute right-4 top-3 text-gray-400 text-sm";
            state.isFooterExpanded = false;
        }

        function renderFooter() {
            const t = document.getElementById('thumbs'); t.innerHTML = '';
            
            state.selected.forEach(id => {
                const p = state.allPhotosMap.get(id); if(!p) return;
                const div = document.createElement('div');
                div.className = "relative flex-shrink-0 w-12 h-12";
                div.innerHTML = `
                    <img src="${p.url}" class="w-full h-full rounded object-cover border border-gray-300 dark:border-gray-600 cursor-pointer" onclick="toggle('${id}')">
                    <button onclick="event.stopPropagation(); toggle('${id}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-sm z-10 border border-white dark:border-darkcard">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                t.appendChild(div);
            });
        }

        function renderMaximizedGrid() {
            const g = document.getElementById('maximizedGrid'); g.innerHTML = '';
            
            const selectedPhotos = Array.from(state.selected).map(id => state.allPhotosMap.get(id)).filter(p => p);

            selectedPhotos.forEach((p, index) => {
                const d = document.createElement('div');
                d.className = "relative aspect-square rounded-lg overflow-hidden group bg-gray-200 dark:bg-gray-800 cursor-pointer";
                
                // Klik tengah untuk membuka Preview (BUKAN Toggle)
                d.onclick = () => {
                   state.currentPreviewList = selectedPhotos;
                   openPreview(index);
                };

                d.innerHTML = `
                    <img src="${p.url}" class="w-full h-full object-cover">
                    <!-- Tombol Hapus X Merah (Hanya ini yang menghapus) -->
                    <button onclick="event.stopPropagation(); toggle('${p.id}')" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs shadow-md z-10 border-2 border-white">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="absolute bottom-0 w-full bg-black/60 text-white text-[10px] p-1 truncate text-center">${p.name}</div>
                `;
                g.appendChild(d);
            });
        }

        // --- UTILS ---
        function toggleSort() { 
            if(!state.activeTabId) return;
            const tab = state.tabs.find(t=>t.id===state.activeTabId);
            if (tab && tab.photos) {
                state.sortAsc = !state.sortAsc; 
                document.getElementById('sortIcon').className = state.sortAsc ? "fas fa-sort-alpha-down text-lg" : "fas fa-sort-alpha-up text-lg"; 
                renderGrid(tab.photos); 
            }
        }
        function toggleTheme() { const h=document.documentElement; if(h.classList.contains('dark')){h.classList.remove('dark');localStorage.setItem('theme','light');}else{h.classList.add('dark');localStorage.setItem('theme','dark');} }
        function updateUI() { const c=state.selected.size; document.getElementById('count').innerText=c; document.getElementById('max').innerText=state.limit; document.getElementById('quotaLeft').innerText=state.limit-c; document.getElementById('warn').style.display=c>=state.limit?'inline':'none'; }
        
        function scrollEl(id, dir) {
            const el = document.getElementById(id);
            el.scrollBy({ left: dir * 200, behavior: 'smooth' });
        }

        function saveDraft() { localStorage.setItem('draft_'+state.name, JSON.stringify({t:Date.now(), ids:Array.from(state.selected), cache:Array.from(state.selected).map(id=>state.allPhotosMap.get(id)).filter(p=>p)})); }
        function loadDraft() { const s=localStorage.getItem('draft_'+state.name); if(s){ try{const d=JSON.parse(s); if(Date.now()-d.t<604800000){ d.ids.forEach(i=>state.selected.add(i)); if(d.cache)d.cache.forEach(p=>state.allPhotosMap.set(p.id,p)); renderFooter(); }}catch(e){} } }

        async function processOrder() {
            if(state.selected.size===0) return; if(!confirm(`Kirim ${state.selected.size} foto?`)) return;
            document.getElementById('sendingOverlay').classList.remove('hidden');
            const files = []; state.selected.forEach(id => { const p=state.allPhotosMap.get(id); if(p) files.push(p.name); });
            try {
                await fetch(CONST_SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({projectName:state.name, files:files}) });
                await new Promise(r=>setTimeout(r,1500));
                const waText = `*${state.name}*\nTotal: ${files.length} Foto\n\nFilename:\n` + files.join('\n');
                window.open(`https://wa.me/${state.wa}?text=${encodeURIComponent(waText)}`, '_blank');
                localStorage.removeItem('draft_'+state.name); window.location.reload();
            } catch(e) {
                alert("Mengalihkan ke WhatsApp...");
                const waText = `*${state.name}*\nTotal: ${files.length} Foto\n\nFilename:\n` + files.join('\n');
                window.open(`https://wa.me/${state.wa}?text=${encodeURIComponent(waText)}`, '_blank');
            }
        }
        function fail(m) { document.getElementById('error').classList.remove('hidden'); document.getElementById('errMsg').innerText=m; document.getElementById('loader').classList.add('hidden'); }
        
        function reset() { 
            if(confirm('Hapus semua pilihan?')) { 
                state.selected.clear(); 
                saveDraft();
                renderFooter(); updateUI(); 
                if(!document.getElementById('maximizedPanel').classList.contains('hidden')) renderMaximizedGrid();
                
                if (state.activeTabId) {
                    const currentTab = state.tabs.find(t => t.id === state.activeTabId);
                    if (currentTab && currentTab.photos) {
                        renderGrid(currentTab.photos);
                    }
                }
            } 
        }
    </script>
</body>
</html>
